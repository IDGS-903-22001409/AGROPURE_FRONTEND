<!-- src/app/features/products/product-detail/product-detail.html - ACTUALIZADO -->
<div class="product-detail-container" *ngIf="product">
  <div class="breadcrumb">
    <a routerLink="/products">Productos</a>
    <mat-icon>chevron_right</mat-icon>
    <span>{{ product.name }}</span>
  </div>

  <div class="product-header">
    <div class="product-image">
      <mat-icon class="product-icon">water_drop</mat-icon>
    </div>

    <div class="product-info">
      <h1>{{ product.name }}</h1>
      <p class="product-description">{{ product.description }}</p>

      <!-- Información de rating y reseñas -->
      <div class="rating-summary" *ngIf="getReviewCount() > 0">
        <app-rating-display [rating]="getAverageRating()" [showValue]="true">
        </app-rating-display>
        <span class="review-count">
          ({{ getReviewCount() }} reseña{{ getReviewCount() !== 1 ? "s" : "" }})
        </span>
      </div>

      <div class="price-info">
        <span class="price-label">Precio desde:</span>
        <span class="price">${{ product.basePrice | number : "1.2-2" }}</span>
      </div>

      <div class="product-actions">
        <button
          mat-raised-button
          color="primary"
          [routerLink]="['/quotes']"
          [queryParams]="{ productId: product.id }"
        >
          <mat-icon>request_quote</mat-icon>
          Solicitar Cotización
        </button>
        <button mat-stroked-button routerLink="/products">
          <mat-icon>arrow_back</mat-icon>
          Volver al Catálogo
        </button>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <div class="product-details">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Componentes Incluidos</mat-card-title>
        <mat-card-subtitle
          >Materiales y especificaciones técnicas</mat-card-subtitle
        >
      </mat-card-header>
      <mat-card-content>
        <div
          class="materials-grid"
          *ngIf="product.materials.length > 0; else noMaterials"
        >
          <div class="material-item" *ngFor="let material of product.materials">
            <div class="material-info">
              <h3>{{ material.materialName }}</h3>
              <p>Cantidad: {{ material.quantity }}</p>
              <p>Costo unitario: ${{ material.unitCost | number : "1.2-2" }}</p>
            </div>
            <div class="material-cost">
              <span class="total-cost">
                ${{ material.quantity * material.unitCost | number : "1.2-2" }}
              </span>
            </div>
          </div>
        </div>

        <ng-template #noMaterials>
          <p class="no-materials">
            No hay información de materiales disponible.
          </p>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Características del Sistema</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="features-list">
          <div class="feature-item">
            <mat-icon>sensors</mat-icon>
            <div>
              <h4>Sensores IoT Integrados</h4>
              <p>
                Monitoreo continuo de pH, conductividad, turbidez y otros
                parámetros críticos
              </p>
            </div>
          </div>

          <div class="feature-item">
            <mat-icon>cloud</mat-icon>
            <div>
              <h4>Conectividad en la Nube</h4>
              <p>
                Acceso remoto y almacenamiento de datos históricos para análisis
              </p>
            </div>
          </div>

          <div class="feature-item">
            <mat-icon>auto_fix_high</mat-icon>
            <div>
              <h4>Automatización Inteligente</h4>
              <p>
                Ajuste automático de parámetros basado en condiciones del
                cultivo
              </p>
            </div>
          </div>

          <div class="feature-item">
            <mat-icon>mobile_friendly</mat-icon>
            <div>
              <h4>App Móvil</h4>
              <p>
                Control y monitoreo desde cualquier lugar con notificaciones en
                tiempo real
              </p>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Sección de FAQ -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>Preguntas Frecuentes</mat-card-title>
        <mat-card-subtitle
          >Todo lo que necesitas saber sobre este producto</mat-card-subtitle
        >
      </mat-card-header>
      <mat-card-content>
        <mat-accordion class="faq-accordion">
          <mat-expansion-panel
            *ngFor="let faq of productFAQs"
            class="faq-panel"
          >
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon class="faq-icon">help_outline</mat-icon>
                {{ faq.question }}
              </mat-panel-title>
            </mat-expansion-panel-header>
            <p class="faq-answer">{{ faq.answer }}</p>
          </mat-expansion-panel>
        </mat-accordion>
      </mat-card-content>
    </mat-card>

    <!-- Sección de Reseñas ACTUALIZADA -->
    <mat-card>
      <mat-card-header>
        <div class="reviews-header">
          <div class="reviews-title">
            <mat-card-title>Reseñas de Clientes</mat-card-title>
            <mat-card-subtitle *ngIf="reviews.length > 0">
              {{ reviews.length }} reseña{{ reviews.length !== 1 ? "s" : "" }}
              <span *ngIf="getAverageRating() > 0">
                • Promedio: {{ getAverageRating() }}/5 estrellas
              </span>
            </mat-card-subtitle>
            <mat-card-subtitle *ngIf="reviews.length === 0">
              Sé el primero en escribir una reseña
            </mat-card-subtitle>
          </div>

          <!-- Botón para escribir reseña -->
          <div class="review-action" *ngIf="currentUser$ | async">
            <button
              mat-raised-button
              color="accent"
              [disabled]="!canWriteReview || showReviewForm"
              (click)="showReviewFormHandler()"
              *ngIf="!showReviewForm"
            >
              <mat-icon>rate_review</mat-icon>
              {{ getUserReviewStatus() }}
            </button>
          </div>

          <!-- Botón para usuarios no autenticados -->
          <div class="review-action" *ngIf="!(currentUser$ | async)">
            <button mat-stroked-button routerLink="/login">
              <mat-icon>login</mat-icon>
              Inicia sesión para escribir una reseña
            </button>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <!-- Formulario de reseña -->
        <app-review-form
          [productId]="product.id"
          [showForm]="showReviewForm"
          (reviewSubmitted)="onReviewSubmitted()"
          (formCancelled)="onReviewFormCancelled()"
        >
        </app-review-form>

        <!-- Lista de reseñas existentes -->
        <div class="reviews-list" *ngIf="reviews.length > 0">
          <div class="review-item" *ngFor="let review of reviews">
            <div class="review-header">
              <div class="reviewer-info">
                <mat-icon class="avatar-icon">account_circle</mat-icon>
                <strong>{{ review.userName }}</strong>
              </div>
              <div class="review-rating">
                <app-rating-display
                  [rating]="review.rating"
                ></app-rating-display>
              </div>
            </div>
            <p class="review-comment">{{ review.comment }}</p>
            <div class="review-meta">
              <small class="review-date">
                <mat-icon>schedule</mat-icon>
                {{ review.createdAt | date : "dd/MM/yyyy" }}
              </small>
            </div>
          </div>
        </div>

        <!-- Estado sin reseñas -->
        <div class="no-reviews" *ngIf="reviews.length === 0 && !showReviewForm">
          <mat-icon>reviews</mat-icon>
          <h3>Sin reseñas aún</h3>
          <p>
            ¿Has usado este producto? Comparte tu experiencia con otros
            clientes.
          </p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<div class="loading-container" *ngIf="!product">
  <mat-icon>hourglass_empty</mat-icon>
  <p>Cargando información del producto...</p>
</div>
