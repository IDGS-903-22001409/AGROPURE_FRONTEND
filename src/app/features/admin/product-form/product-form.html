<div class="product-form">
  <h2 mat-dialog-title>
    {{ data ? "Editar Producto" : "Nuevo Producto" }}
  </h2>

  <mat-dialog-content>
    <form [formGroup]="productForm">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nombre del Producto</mat-label>
        <input matInput formControlName="name" required />
        <mat-error *ngIf="productForm.get('name')?.hasError('required')">
          El nombre es requerido
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Descripción</mat-label>
        <textarea matInput formControlName="description" rows="3"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Descripción Detallada</mat-label>
        <textarea
          matInput
          formControlName="detailedDescription"
          rows="4"
        ></textarea>
      </mat-form-field>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Categoría</mat-label>
          <input matInput formControlName="category" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>URL de Imagen</mat-label>
          <input matInput formControlName="imageUrl" />
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Especificaciones Técnicas</mat-label>
        <textarea matInput formControlName="technicalSpecs" rows="3"></textarea>
      </mat-form-field>

      <mat-card class="materials-section">
        <mat-card-header>
          <mat-card-title>Materiales Incluidos</mat-card-title>
          <mat-card-subtitle
            >Define los materiales y cantidades</mat-card-subtitle
          >
        </mat-card-header>
        <mat-card-content>
          <div formArrayName="materials">
            <div
              *ngFor="let material of materialsArray.controls; let i = index"
              [formGroupName]="i"
              class="material-row"
            >
              <mat-form-field appearance="outline" class="material-select">
                <mat-label>Material</mat-label>
                <mat-select
                  formControlName="materialId"
                  (selectionChange)="onMaterialChange(i)"
                >
                  <mat-option
                    *ngFor="let mat of availableMaterials"
                    [value]="mat.id"
                  >
                    {{ mat.name }} - ${{ mat.unitCost | number : "1.2-2" }} /
                    {{ mat.unit }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="quantity-field">
                <mat-label>Cantidad</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="quantity"
                  (input)="calculateTotal()"
                  min="0.01"
                  step="0.01"
                />
              </mat-form-field>

              <button
                mat-icon-button
                color="warn"
                type="button"
                (click)="removeMaterial(i)"
                *ngIf="materialsArray.length > 1"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

          <button
            mat-stroked-button
            type="button"
            (click)="addMaterial()"
            class="add-material-btn"
          >
            <mat-icon>add</mat-icon>
            Agregar Material
          </button>

          <div class="cost-calculation" *ngIf="calculatedCost > 0">
            <div class="cost-row">
              <span>Costo de Materiales:</span>
              <span class="cost-value"
                >${{ materialsCost | number : "1.2-2" }}</span
              >
            </div>
            <div class="cost-row">
              <span>Mano de Obra (30%):</span>
              <span class="cost-value"
                >${{ laborCost | number : "1.2-2" }}</span
              >
            </div>
            <div class="cost-row">
              <span>Gastos Generales (20%):</span>
              <span class="cost-value"
                >${{ overheadCost | number : "1.2-2" }}</span
              >
            </div>
            <div class="cost-row">
              <span>Margen de Ganancia (25%):</span>
              <span class="cost-value"
                >${{ profitMargin | number : "1.2-2" }}</span
              >
            </div>
            <div class="cost-row total">
              <span><strong>Precio Base Sugerido:</strong></span>
              <span class="cost-value"
                ><strong>${{ calculatedCost | number : "1.2-2" }}</strong></span
              >
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions>
    <button mat-button (click)="onCancel()">Cancelar</button>
    <button
      mat-raised-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="productForm.invalid || isLoading"
    >
      {{ isLoading ? "Guardando..." : data ? "Actualizar" : "Crear" }}
    </button>
  </mat-dialog-actions>
</div>
