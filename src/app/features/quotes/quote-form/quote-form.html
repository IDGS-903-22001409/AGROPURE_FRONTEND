<div class="quote-container">
  <mat-card class="quote-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>request_quote</mat-icon>
        Solicitar Cotización
      </mat-card-title>
      <mat-card-subtitle>
        Obtén una cotización personalizada para tu sistema AGROPURE
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <mat-stepper #stepper orientation="vertical" [linear]="true">
        <!-- Paso 1: Selección de Producto -->
        <mat-step [stepControl]="productForm" label="Seleccionar Producto">
          <form [formGroup]="productForm">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Producto</mat-label>
              <mat-select
                formControlName="productId"
                (selectionChange)="onProductChange($event.value)"
              >
                <mat-option
                  *ngFor="let product of products"
                  [value]="product.id"
                >
                  {{ product.name }} - ${{
                    product.basePrice | number : "1.2-2"
                  }}
                </mat-option>
              </mat-select>
              <mat-error
                *ngIf="productForm.get('productId')?.hasError('required')"
              >
                Selecciona un producto
              </mat-error>
            </mat-form-field>

            <div class="product-details" *ngIf="selectedProduct">
              <h3>{{ selectedProduct.name }}</h3>
              <p>{{ selectedProduct.description }}</p>
              <p>
                <strong>Precio base:</strong> ${{
                  selectedProduct.basePrice | number : "1.2-2"
                }}
              </p>
            </div>

            <div class="step-actions">
              <button
                mat-raised-button
                color="primary"
                matStepperNext
                [disabled]="productForm.invalid"
              >
                Continuar
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Paso 2: Cantidad y Cálculos -->
        <mat-step [stepControl]="quantityForm" label="Cantidad y Presupuesto">
          <form [formGroup]="quantityForm">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Cantidad</mat-label>
              <input
                matInput
                type="number"
                formControlName="quantity"
                min="1"
                (input)="calculatePrice()"
              />
              <mat-error
                *ngIf="quantityForm.get('quantity')?.hasError('required')"
              >
                La cantidad es requerida
              </mat-error>
              <mat-error *ngIf="quantityForm.get('quantity')?.hasError('min')">
                La cantidad mínima es 1
              </mat-error>
            </mat-form-field>

            <div class="price-calculation" *ngIf="priceCalculation">
              <div class="price-row">
                <span>Precio unitario:</span>
                <span
                  >${{ priceCalculation.unitPrice | number : "1.2-2" }}</span
                >
              </div>
              <div class="price-row" *ngIf="priceCalculation.discount > 0">
                <span>Descuento ({{ getDiscountPercentage() }}%):</span>
                <span class="discount"
                  >-${{ priceCalculation.discount | number : "1.2-2" }}</span
                >
              </div>
              <div class="price-row total">
                <span><strong>Total:</strong></span>
                <span
                  ><strong
                    >${{
                      priceCalculation.totalCost | number : "1.2-2"
                    }}</strong
                  ></span
                >
              </div>
            </div>

            <div class="discount-info">
              <h4>Descuentos por Volumen:</h4>
              <ul>
                <li>3+ unidades: 5% de descuento</li>
                <li>5+ unidades: 10% de descuento</li>
                <li>10+ unidades: 15% de descuento</li>
              </ul>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>Atrás</button>
              <button
                mat-raised-button
                color="primary"
                matStepperNext
                [disabled]="quantityForm.invalid"
              >
                Continuar
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Paso 3: Notas Adicionales -->
        <mat-step [stepControl]="notesForm" label="Información Adicional">
          <form [formGroup]="notesForm">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label
                >Notas o Requerimientos Especiales (Opcional)</mat-label
              >
              <textarea
                matInput
                formControlName="customerNotes"
                rows="4"
                placeholder="Describe cualquier requerimiento especial o pregunta sobre el producto..."
              ></textarea>
            </mat-form-field>

            <div class="step-actions">
              <button mat-button matStepperPrevious>Atrás</button>
              <button
                mat-raised-button
                color="primary"
                (click)="submitQuote()"
                [disabled]="isSubmitting"
              >
                <mat-icon>send</mat-icon>
                {{ isSubmitting ? "Enviando..." : "Enviar Cotización" }}
              </button>
            </div>
          </form>
        </mat-step>
      </mat-stepper>
    </mat-card-content>
  </mat-card>
</div>
